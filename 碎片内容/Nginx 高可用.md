## Nginx
### Nginx 是什么
Nginx 是 lgor Sysoev 为俄罗斯访问量第二的 rambler.ru 站点设计开发的。从 2004 年发布至今，凭借开源的力量，已经接近成熟与完善。
Nginx功能丰富，可作为HTTP服务器，也可作为反向代理服务器，邮件服务器。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。

### Nginx 的功能
1. 正向/反向代理
2. 负载均衡
3. web 缓存

### Nginx 与 Apache 的对比
Nginx 的编写有一个明确目标就是超越 Apache Web 服务器的性能。Nginx 提供开箱即用的静态文件，使用的内存比 Apache 少得多，每秒可以处理大约四倍于 Apache 的请求。 在低并发下Nginx 的性能与 Apache 相当（有时候还低于），但是在高并发下 Nginx 能保持低资源低消耗高性能。Nginx 的优点还包括：高度模块化的设计，模块编写简单，以及配置文件简洁。

## Nginx 高可用

现代的高可用方案大同小异，均基于 Nginx + Keepalived
>如果是四层网络体系，不会用 Nginx

### 什么是高可用
也就是 SLA，**监管要求是 99.85%**，大厂 toB 一般要求 4 个 9 甚至 5 个 9，因为高 SLA 是云服务重要的宣传指标。

停机是可用性受影响的主要因素，包含如下内容：
- 计划内停机：一般就是指计划的时间内一定会对系统造成破坏性维护的结果，比如软件系统升级，数据库或者服务器的维护。
- 计划外停机：一般就是值断电、CPU故障或者其他物理层面的断开连接，比如网络故障，中间件故障等。

在计划内停机，Nginx 有两种重启方式：quit 和 reload

- quit：暴力停机，导致 Nginx 数秒到数分钟内暂时不可用
- reload：不停机，暂时不接受流量，处理完当下流量后重新上线

两种停机都会带来一定程度的 SLA 影响

高可用的本质就是**冗余 + 故障转移**，但不是堆服务器就能完成的，所以需要一个稳健的架构来构建高可用体系

### 简单的负载均衡架构

Nginx 虽然是一个 web 中间件，但作为负载均衡时，不提供 web 服务，仅转发流量给下游。

![[Pasted image 20241031081844.png]]<center>Nginx 作为<b>负载均衡</b>仅转发流量给下游，本身不处理业务逻辑</center>

这就完成了一个最简单的负载均衡。

### 相对复杂的负载均衡

Nginx 如果只做负载均衡，没有问题

但如果为了可用性，Nginx 还要担负一个重要职责：探活，在发现某台 RS down 时，自动将其抽离 cluster。但 Nginx 本身也会 down，也会因流量过多而不可用，所以 Nginx 也是多台的，也需要相对应的 cluster。

![[Pasted image 20241031084448.png]]<center>多台 Nginx 组成 Cluster 转发流量、共同探活，当 Nginx 自身不可用时由 Cluster 内的其他机器顶上</center>

通过上图的架构，这些机器组成了一个 DC，用户的流量进入 DC 后，由机器自动分配。
>有一个重要原则：单个用户的流量**尽量**由单台 Nginx 和单台 RS 处理，多台机器一起处理一个用户的请求导致的开销通常较大。

>通过**流量整形**，可以限制到达具体某一台机器的流量、校验鉴权、防爬虫等功能，但不属于高可用架构的内容

### 高可用集群
在上一个负载均衡的基础上，在网络层再引入支持协议更广、抗负载能力更高的 LVS

![[Pasted image 20241031103658.png]]<center>一个基本的高可用集群单元</center>

LVS 的优点如下：
- 主要用于多服务器的负载均衡
- 工作在网络层，可实现高性能，高可用的服务器集群技术
- 廉价，可把许多低性能的服务器组合在一起形成一个超级服务器
- 易用，配置简单，有多种负载均衡的方法
- 稳定可靠，即使在集群的服务器中某台服务器无法正常工作，也不影响整体效果
- 可扩展性好

最重要的是支持 **VIP**(Virtual IP)，支持 VIP 将保证主备功能的切换

>VIP 就是虚拟 IP 地址（Virtual IP Address）。通常一个 IP 只能绑定在一个网卡上，一旦这台机器故障，客户端根据 IP 找到这台机器的请求就会得不到响应。
>在集群中，通过 VIP 可以保证只要集群内的机器不是全挂，访问一个固定 IP 总有机器响应

![[Pasted image 20241031151401.png]]<center>主 Nginx 不可用时，备 Nginx 自动抢占 VIP，继续提供服务</center>

**自动抢占 VIP 的过程称为漂移**，分为两个模式：主备模式和备备模式
- Master-> Backup 模式 ： 主机宕机时，虚拟 IP 会自动漂移到备机，当 Keepalived 监听到主机修复后，还会把 VIP 移动过来。
- Backup-> Backup 模式：主机宕机时，虚拟 IP 会自动漂移到备机，但是即使主机修复， VIP 也不会改变，而是一直用原来的 Backup 备机作为主机。
### 高可用集群 + Keepalived

Keepalived 是一款为 LVS 负载均衡设计的状态检测和切换工具，能监控集群中各个节点的状态，之后又加入了虚拟路由器冗余协议功能 VRRP，通过 VRRP 就可以实现 VIP 的故障转移。

其本质就是将探活转移到性能更强大的 LVS 上，并分担一部分负载均衡的工作，Nginx 仅专注于负载均衡

![[Pasted image 20241031120819.png]]<center>正常情况下主 LVS 提供服务，备 LVS 探活</center>

![[Pasted image 20241031121143.png]]<center>主 LVS down 时，备 LVS 提供服务</center>


## DC 的负载均衡
众所周知 DC 不止一个，DC 也需要负载均衡

### 通过 DNS 负载均衡 DC

DC 通过 DNS 做负载均衡，通常取决于用户地区。也就是根据用户的位置返回**最近的/相对近且负载较小的**服务器

![[Pasted image 20241031091359.png]]<center>如果用户离 DC01 最近，则返回 DC01，有时候 DC01 忙，那就返回 DC02</center>

### 动态加速（通过 DNS 负载均衡 CDN）
基于负载均衡出现的新架构，客户端不直接连接 DC

![[Pasted image 20241031092332.png]]<center>取消直接访问 DC，改为访问 CDN</center>
这个架构好处如下：
1. 隐藏真实 IP，提高网络攻击的门槛
2. 对外网络策略更简单
3. CDN 将协助处理部分内容，大流量内容将由 CDN 缓存分发而不是直接走 DC，节省 DC 流量开支，进而节省成本

## 其他相关内容
### Nginx 集群批量升级原则
1. 测试
2. 从非核心业务中的一个集群开始
3. 上线后观察
4. 慢慢往大规模、核心业务升级
5. 再观察

### 大厂自研 Nginx
NGINX 其实是款非常出色的 Web 服务器、负载均衡器和简单网关。问题是大厂的需求远不止于此，所以它们就会自研这些中间件，并随时根据需求调整

以往，常规做法都是围绕 NGINX 构建自己需要的各项功能，但同时还要避免同 NGINX 的上游代码库发生严重分歧，这为开发实现功能产生了极大的阻碍。而自研就能根据自己的需求放开手脚大干一场

例如某家短视频大厂自研的 Nginx 能实现一些原来不具备的功能：盲水印、内容安全检测等

某全球 CDN 大厂自研的 Nginx 能代理快速、高效且安全地处理每秒数百万条请求，还要保证支持种种稀奇古怪、不符合 RFC 的 HTTP 流量，甚至还能在不影响性能的前提下，以内存安全的方式带来可与 C 语言比肩的极佳性能

某主营音乐的游戏“小”厂自研的 Nginx 能在 8 核部署的设备 TPS 可以达到 12W 左右，是同环境下基于 Java 的异步化 API 网关的 4.2 倍左右，是基于 Nginx 的 Kong 的 2.4 倍，是 APISIX 的 1.3 倍。还能提供丰富的功能、可观测、动态配置、扩展性，不需要特别的扩展编程即可满足绝大多数流量治理场景下对网关的功能与性能稳定性需求

> 此处的 Nginx 仅为“实现类似 Nginx 这样的代理/反向代理类 web 中间件”的称呼，**完全与 Nginx 项目无关**
